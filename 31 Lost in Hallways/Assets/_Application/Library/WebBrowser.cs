using System.Collections;
using System.Collections.Generic;
using UnityEngine;

//-----------------------------------------------------------------------------------------------------------------------------------
// -
//-----------------------------------------------------------------------------------------------------------------------------------
public class WebBrowser : MonoBehaviour
{
#if WEB_VIEW
	//-------------------------------------------------------------------------------------------------------------------------------
    // -
	//-------------------------------------------------------------------------------------------------------------------------------
	public WebViewObject	webViewObject;
#endif

	//-------------------------------------------------------------------------------------------------------------------------------
    // -
	//-------------------------------------------------------------------------------------------------------------------------------
	public void Open( RectTransform panel, string Url, int _BottomMargin=(0) )
	{
		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		if( (panel)==(null) ) return;
		if( !Library.Is(Url) ) return;

#if WEB_VIEW
		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		(webViewObject)		= gameObject.AddComponent<WebViewObject>();

		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		webViewObject.Init(
			cb: (msg) =>
			{
				Debug.Log(string.Format("CallFromJS[{0}]", msg));
//				status.text = msg;
//				status.GetComponent<Animation>().Play();
			},
			err: (msg) =>
			{
				Debug.Log(string.Format("CallOnError[{0}]", msg));
//				status.text = msg;
//				status.GetComponent<Animation>().Play();
				onError();
			},
			started: (msg) =>
			{
				Debug.Log(string.Format("CallOnStarted[{0}]", msg));
			},
			ld: (msg) =>
			{
				Debug.Log(string.Format("CallOnLoaded[{0}]", msg));
#if UNITY_EDITOR_OSX || !UNITY_ANDROID
				// NOTE: depending on the situation, you might prefer
				// the 'iframe' approach.
				// cf. https://github.com/gree/unity-webview/issues/189
#if true
				webViewObject.EvaluateJS(@"
				  if (window && window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.unityControl) {
					window.Unity = {
					  call: function(msg) {
						window.webkit.messageHandlers.unityControl.postMessage(msg);
					  }
					}
				  } else {
					window.Unity = {
					  call: function(msg) {
						window.location = 'unity:' + msg;
					  }
					}
				  }
				");
#else
				webViewObject.EvaluateJS(@"
				  if (window && window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.unityControl) {
					window.Unity = {
					  call: function(msg) {
						window.webkit.messageHandlers.unityControl.postMessage(msg);
					  }
					}
				  } else {
					window.Unity = {
					  call: function(msg) {
						var iframe = document.createElement('IFRAME');
						iframe.setAttribute('src', 'unity:' + msg);
						document.documentElement.appendChild(iframe);
						iframe.parentNode.removeChild(iframe);
						iframe = null;
					  }
					}
				  }
				");
#endif
#endif
				webViewObject.EvaluateJS(@"Unity.call('ua=' + navigator.userAgent)");
				onLoaded();
			},
			//ua: "custom user agent string",
			enableWKWebView: true);

		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
#if UNITY_EDITOR_OSX || UNITY_STANDALONE_OSX
		webViewObject.bitmapRefreshCycle = 1;
#endif

		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		int		MarginH			= (int)( (Screen.width)		* ( Func.Dividef( (int)( tagSystem.GetScreenWidth() - (panel.sizeDelta.x) )+(40),	tagSystem.GetScreenWidth() ) )	/ (2) );
		int		MarginV			= (int)( (Screen.height)	* ( Func.Dividef( (int)( tagSystem.GetScreenHeight() - (panel.sizeDelta.y) )+(80),	tagSystem.GetScreenHeight() ) ) / (2) );
		int		VPosition		= (int)( (Screen.height)	* ( Func.Dividef( (int)(panel.localPosition.y),	tagSystem.GetScreenHeight() ) ) );
		int		BottomMargin	= (int)( (Screen.height)	* ( Func.Dividef( (_BottomMargin),	tagSystem.GetScreenHeight() ) ) );
		webViewObject.SetMargins( (MarginH), (MarginV)-(VPosition), (MarginH), (MarginV)+(VPosition)+(BottomMargin) );
		webViewObject.SetVisibility(true);

		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
#if !UNITY_WEBPLAYER
		if( Url.StartsWith("http") )
		{
			webViewObject.LoadURL( Url.Replace(" ", "%20") );
		}
		/*
		else
		{
			//-----------------------------------------------------------------------------------------------------------------------
			// -
			//-----------------------------------------------------------------------------------------------------------------------
			var exts = new string[]
			{
				".jpg",
				".js",
				".html"  // should be last
			};

			//-----------------------------------------------------------------------------------------------------------------------
			// -
			//-----------------------------------------------------------------------------------------------------------------------
			foreach( var ext in exts )
			{
				//-------------------------------------------------------------------------------------------------------------------
				// -
				//-------------------------------------------------------------------------------------------------------------------
				var url = Url.Replace(".html", ext);
				var src = System.IO.Path.Combine(Application.streamingAssetsPath, url);
				var dst = System.IO.Path.Combine(Application.persistentDataPath, url);
				byte[] result = null;

				//-------------------------------------------------------------------------------------------------------------------
				// -
				//-------------------------------------------------------------------------------------------------------------------
				if( src.Contains("://") )
				{  // for Android
					var www = new WWW(src);
					yield return www;
					result = www.bytes;
				}
				else
				{
					result = System.IO.File.ReadAllBytes(src);
				}

				//-------------------------------------------------------------------------------------------------------------------
				// -
				//-------------------------------------------------------------------------------------------------------------------
				System.IO.File.WriteAllBytes(dst, result);

				//-------------------------------------------------------------------------------------------------------------------
				// -
				//-------------------------------------------------------------------------------------------------------------------
				if( (ext)==".html" )
				{
					webViewObject.LoadURL( "file://"+dst.Replace(" ", "%20") );
					break;
				}

				//-------------------------------------------------------------------------------------------------------------------
				// -
				//-------------------------------------------------------------------------------------------------------------------
			}

			//-----------------------------------------------------------------------------------------------------------------------
			// -
			//-----------------------------------------------------------------------------------------------------------------------
		}
		*/
#else
		if (Url.StartsWith("http")) {
			webViewObject.LoadURL(Url.Replace(" ", "%20"));
		} else {
			webViewObject.LoadURL("StreamingAssets/" + Url.Replace(" ", "%20"));
		}
		webViewObject.EvaluateJS(
			"parent.$(function() {" +
			"   window.Unity = {" +
			"       call:function(msg) {" +
			"           parent.unityWebView.sendMessage('WebViewObject', msg)" +
			"       }" +
			"   };" +
			"});");
#endif

		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
#endif
	}

	//-------------------------------------------------------------------------------------------------------------------------------
    // -
	//-------------------------------------------------------------------------------------------------------------------------------
	void onError()
	{
		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		CApp.This.Engine.NativeIndigatorInactive();

		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
	}

	//-------------------------------------------------------------------------------------------------------------------------------
    // -
	//-------------------------------------------------------------------------------------------------------------------------------
	void onLoaded()
	{
		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		CApp.This.Engine.NativeIndigatorInactive();

		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
	}

	//-------------------------------------------------------------------------------------------------------------------------------
    // 인터페이스를 활성화 하기 위한 함수
	//-------------------------------------------------------------------------------------------------------------------------------
	public void Active()
	{
#if WEB_VIEW
		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		if( (webViewObject)!=(null) )
		{
			webViewObject.SetVisibility( true );
		}
#endif

		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
	}

	//-------------------------------------------------------------------------------------------------------------------------------
    // 인터페이스를 비활성화 하기 위한 함수
	//-------------------------------------------------------------------------------------------------------------------------------
	public void Inactive()
	{
#if WEB_VIEW
		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		if( (webViewObject)!=(null) )
		{
			webViewObject.SetVisibility( false );
		}
#endif

		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
	}

	//-------------------------------------------------------------------------------------------------------------------------------
    // -
	//-------------------------------------------------------------------------------------------------------------------------------
}

//-----------------------------------------------------------------------------------------------------------------------------------
// -
//-----------------------------------------------------------------------------------------------------------------------------------
