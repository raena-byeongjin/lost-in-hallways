using System.Collections;
using System.Collections.Generic;
using System;
using UnityEngine;
#if FACEBOOK
	using Facebook.Unity;
#endif

//-----------------------------------------------------------------------------------------------------------------------------------
// 페이스북 정보를 처리하기 위한 클래스
//-----------------------------------------------------------------------------------------------------------------------------------
public class CFacebook : MonoBehaviour
{
#if FACEBOOK
	//-------------------------------------------------------------------------------------------------------------------------------
	// -
	//-------------------------------------------------------------------------------------------------------------------------------
	[System.Serializable]
	public class tagData
	{
		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		public string						id				= (null);
		public string						Name			= (null);

		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		public List<tagFacebookProfile>		Profiles		= new List<tagFacebookProfile>();

		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
	};
	public tagData	data	= new tagData();

	//-------------------------------------------------------------------------------------------------------------------------------
	// -
	//-------------------------------------------------------------------------------------------------------------------------------
	CApp	app		= (null);
	CPlay	play	= (null);

	//-------------------------------------------------------------------------------------------------------------------------------
	// -
	//-------------------------------------------------------------------------------------------------------------------------------
	void OnEnable()
	{
		(this.app)		= (CApp.This);
		(this.play)		= (CPlay.This);
	}

	//-------------------------------------------------------------------------------------------------------------------------------
	// 페이스북을 시작하기 위한 함수
	//-------------------------------------------------------------------------------------------------------------------------------
	public void _Startup()
	{
        //---------------------------------------------------------------------------------------------------------------------------
        // -
        //---------------------------------------------------------------------------------------------------------------------------
#if FACEBOOK
	#if !UNITY_EDITOR && UNITY_ANDROID
		FB.Init( (OnInit), (OnHideUnity) );
	#else
		FB.Init( (OnInit), (OnHideUnity) );
	#endif
#endif

        //---------------------------------------------------------------------------------------------------------------------------
        // -
        //---------------------------------------------------------------------------------------------------------------------------
	}

	//-------------------------------------------------------------------------------------------------------------------------------
	// -
	//-------------------------------------------------------------------------------------------------------------------------------
    void OnInit()
    {
        //---------------------------------------------------------------------------------------------------------------------------
        // -
        //---------------------------------------------------------------------------------------------------------------------------
		/*
        this.Status = "Success - Check logk for details";
        this.LastResponse = "Success Response: OnInitComplete Called\n";
        string logMessage = string.Format(
            "OnInitCompleteCalled IsLoggedIn='{0}' IsInitialized='{1}'",
            FB.IsLoggedIn,
            FB.IsInitialized);
        LogView.AddLog(logMessage);
		*/

        //---------------------------------------------------------------------------------------------------------------------------
        // -
        //---------------------------------------------------------------------------------------------------------------------------
		if( IsLogin() )
		{
			OnLogin();
		}
		else
		{
			app.ViewIndigator.OFF( this );
		}

        //---------------------------------------------------------------------------------------------------------------------------
        // -
        //---------------------------------------------------------------------------------------------------------------------------
    }

	//-------------------------------------------------------------------------------------------------------------------------------
	// -
	//-------------------------------------------------------------------------------------------------------------------------------
    private void OnHideUnity( bool isGameShown )
    {
        //---------------------------------------------------------------------------------------------------------------------------
        // -
        //---------------------------------------------------------------------------------------------------------------------------
		/*
        this.Status = "Success - Check logk for details";
        this.LastResponse = string.Format("Success Response: OnHideUnity Called {0}\n", isGameShown);
        LogView.AddLog("Is game shown: " + isGameShown);
		*/
//		app.Confirm.ON( "Success - Check logk for details => "+string.Format("Success Response: OnHideUnity Called {0}\n", isGameShown) );
		Debug.Log( "Success - Check logk for details => "+string.Format("Success Response: OnHideUnity Called {0}\n", isGameShown) );

        //---------------------------------------------------------------------------------------------------------------------------
        // -
        //---------------------------------------------------------------------------------------------------------------------------
    }

	//-------------------------------------------------------------------------------------------------------------------------------
	// 로그인을 처리하기 위한 함수
	//-------------------------------------------------------------------------------------------------------------------------------
    public void Login()
    {
		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		app.ViewIndigator.ON( this );

        //---------------------------------------------------------------------------------------------------------------------------
        // -
        //---------------------------------------------------------------------------------------------------------------------------
#if FACEBOOK
		if( !IsLogin() )
		{
			FB.LogInWithReadPermissions( new List<string>() { "public_profile", "email", "user_friends" }, (HandleResult) );
		}
		else
		{
			OnLogin();
		}
#endif

        //---------------------------------------------------------------------------------------------------------------------------
        // -
        //---------------------------------------------------------------------------------------------------------------------------
    }

	//-------------------------------------------------------------------------------------------------------------------------------
	// 로그아웃을 처리하기 위한 함수
	//-------------------------------------------------------------------------------------------------------------------------------
    public void Logout( object wParam=(null), object lParam=(null) )
    {
#if FACEBOOK
        //---------------------------------------------------------------------------------------------------------------------------
        // -
        //---------------------------------------------------------------------------------------------------------------------------
		if( IsLogin() )
		{
			//-----------------------------------------------------------------------------------------------------------------------
			// -
			//-----------------------------------------------------------------------------------------------------------------------
			FB.LogOut();

			//-----------------------------------------------------------------------------------------------------------------------
			// -
			//-----------------------------------------------------------------------------------------------------------------------
			data.Profiles.Clear();

			//-----------------------------------------------------------------------------------------------------------------------
			// -
			//-----------------------------------------------------------------------------------------------------------------------
			if( app.SceneTitle.Is() )
			{
				app.SceneTitle.Facebook().Login( false );
			}			

			//-----------------------------------------------------------------------------------------------------------------------
			// -
			//-----------------------------------------------------------------------------------------------------------------------
		}

        //---------------------------------------------------------------------------------------------------------------------------
        // -
        //---------------------------------------------------------------------------------------------------------------------------
#endif
    }

	//-------------------------------------------------------------------------------------------------------------------------------
	// 초기화되어 있는지 확인하기 위한 함수
	//-------------------------------------------------------------------------------------------------------------------------------
    public bool IsInit()
    {
        //---------------------------------------------------------------------------------------------------------------------------
        // -
        //---------------------------------------------------------------------------------------------------------------------------
#if FACEBOOK
		return (FB.IsInitialized);
#else
		return false;
#endif

        //---------------------------------------------------------------------------------------------------------------------------
        // -
        //---------------------------------------------------------------------------------------------------------------------------

    }

	//-------------------------------------------------------------------------------------------------------------------------------
	// 로그인되어 있는지 확인하기 위한 함수
	//-------------------------------------------------------------------------------------------------------------------------------
    public bool IsLogin()
    {
        //---------------------------------------------------------------------------------------------------------------------------
        // -
        //---------------------------------------------------------------------------------------------------------------------------
#if FACEBOOK
		return (FB.IsLoggedIn);
#else
		return false;
#endif

        //---------------------------------------------------------------------------------------------------------------------------
        // -
        //---------------------------------------------------------------------------------------------------------------------------
    }

	//-------------------------------------------------------------------------------------------------------------------------------
	// -
	//-------------------------------------------------------------------------------------------------------------------------------
#if FACEBOOK
    protected void HandleResult( IResult result )
    {
        //---------------------------------------------------------------------------------------------------------------------------
        // -
        //---------------------------------------------------------------------------------------------------------------------------
        if( (result)==(null) )
        {
//			this.LastResponse = "Null Response\n";
//			LogView.AddLog(this.LastResponse);
//			app.Confirm.ON( "Null Response" );
			Debug.Log("Null Response");
            return;
        }

//		this.LastResponseTexture = null;

        //---------------------------------------------------------------------------------------------------------------------------
        // Some platforms return the empty string instead of null.
        //---------------------------------------------------------------------------------------------------------------------------
        if( !string.IsNullOrEmpty(result.Error) )
        {
			/*
            this.Status = "Error - Check log for details";
            this.LastResponse = "Error Response:\n" + result.Error;
            LogView.AddLog(result.Error);
			*/
//			app.Confirm.ON( "Error - Check log for details => Error Response:\n" + result.Error );
			Debug.Log("Error - Check log for details => Error Response:\n" + result.Error);
			app.Confirm.ON( "로그인에 실패했습니다.", (CONFIRM.OK) );
			app.ViewIndigator.OFF( this );
        }
        else
		if( result.Cancelled )
        {
			/*
            this.Status = "Cancelled - Check log for details";
            this.LastResponse = "Cancelled Response:\n" + result.RawResult;
            LogView.AddLog(result.RawResult);
			*/
//			app.Confirm.ON( "Cancelled - Check log for details => Cancelled Response:\n" + result.RawResult );
			Debug.Log("Cancelled - Check log for details => Cancelled Response:\n" + result.RawResult);
			app.ViewIndigator.OFF( this );
        }
        else
		if( !string.IsNullOrEmpty(result.RawResult) )
        {
			/*
            this.Status = "Success - Check log for details";
            this.LastResponse = "Success Response:\n" + result.RawResult;
            LogView.AddLog(result.RawResult);
			*/
//			app.Confirm.ON( "Success - Check log for details => Success Response:\n" + result.RawResult );
			OnLogin();
        }
        else
        {
			/*
            this.LastResponse = "Empty Response\n";
            LogView.AddLog(this.LastResponse);
			*/
//			app.Confirm.ON( "Empty Response" );
			Debug.Log("Empty Response");
        }

        //---------------------------------------------------------------------------------------------------------------------------
        // -
        //---------------------------------------------------------------------------------------------------------------------------
    }
#endif

	//-------------------------------------------------------------------------------------------------------------------------------
	// 로그인을 처리하기 위한 함수
	//-------------------------------------------------------------------------------------------------------------------------------
	void OnLogin()
	{
        //---------------------------------------------------------------------------------------------------------------------------
        // -
        //---------------------------------------------------------------------------------------------------------------------------
#if FACEBOOK
		FB.API( "/me?fields=name,id,email,picture", (HttpMethod.GET), (OnProfile) );
//		FB.API( "/me/friends", (HttpMethod.GET), (OnFriendList) );
#endif

        //---------------------------------------------------------------------------------------------------------------------------
        // -
        //---------------------------------------------------------------------------------------------------------------------------
		if( app.SceneTitle.Is() )
		{
			app.SceneTitle.Facebook().Login( true );
		}

        //---------------------------------------------------------------------------------------------------------------------------
        // -
        //---------------------------------------------------------------------------------------------------------------------------
	}

	//-------------------------------------------------------------------------------------------------------------------------------
	// 프로필 입력에 반응하기 위한 함수
	//-------------------------------------------------------------------------------------------------------------------------------
#if FACEBOOK
	void OnProfile( IGraphResult result )
	{
        //---------------------------------------------------------------------------------------------------------------------------
        // -
        //---------------------------------------------------------------------------------------------------------------------------
		if( (result)==(null) ) return;
		if( !Library.Is(result.RawResult) ) return;

        //---------------------------------------------------------------------------------------------------------------------------
        // -
        //---------------------------------------------------------------------------------------------------------------------------
		AppsParameter	col		= AppsParameter.Decode(result.RawResult);
		if( (col)==(null) ) return;

        //---------------------------------------------------------------------------------------------------------------------------
        // -
        //---------------------------------------------------------------------------------------------------------------------------
		ID( col.Get("id") );
		Name( col.Get("name") );

        //---------------------------------------------------------------------------------------------------------------------------
        // -
        //---------------------------------------------------------------------------------------------------------------------------
		if( col.Is("name") )
		{
			//-----------------------------------------------------------------------------------------------------------------------
			// -
			//-----------------------------------------------------------------------------------------------------------------------
//			Debug.Log(result.RawResult);
//			app.Player.Name( Func.CH( "(NOTHING)", col.Get("name") ) );

			//-----------------------------------------------------------------------------------------------------------------------
			// -
			//-----------------------------------------------------------------------------------------------------------------------
			/*
			tagFacebookProfile	profile	= Register( col.Get("id"), col.Get("name"), (true) );
			if( (profile)!=(null) )
			{
				app.Download.ON( GetPictureUrl(col), (OnPicture), (profile) );
			}
			*/

			//-----------------------------------------------------------------------------------------------------------------------
			// -
			//-----------------------------------------------------------------------------------------------------------------------
		}

		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		app.ViewIndigator.OFF( this );

        //---------------------------------------------------------------------------------------------------------------------------
        // -
        //---------------------------------------------------------------------------------------------------------------------------
	}
#endif

	//-------------------------------------------------------------------------------------------------------------------------------
	// 프로필 정보를 등록하기 위한 함수
	//-------------------------------------------------------------------------------------------------------------------------------
	public tagFacebookProfile Register( string id, string name, bool isPlayer=(false) )
	{
        //---------------------------------------------------------------------------------------------------------------------------
        // -
        //---------------------------------------------------------------------------------------------------------------------------
		if( (id)==(null) ) return (null);
//		if( (name)==(null) ) return (null);		//(NULL)값을 허용함

        //---------------------------------------------------------------------------------------------------------------------------
        // -
        //---------------------------------------------------------------------------------------------------------------------------
		tagFacebookProfile		profile		= Find(id);
		if( (profile)==(null) ) (profile)	= new tagFacebookProfile();

        //---------------------------------------------------------------------------------------------------------------------------
        // -
        //---------------------------------------------------------------------------------------------------------------------------
		(profile.id)			= (id);
		(profile.Name)			= (name);

        //---------------------------------------------------------------------------------------------------------------------------
        // -
        //---------------------------------------------------------------------------------------------------------------------------
		if( !data.Profiles.Contains(profile) )
		{
			data.Profiles.Add( profile );
		}

        //---------------------------------------------------------------------------------------------------------------------------
        // -
        //---------------------------------------------------------------------------------------------------------------------------
		return (profile);
	}

	//-------------------------------------------------------------------------------------------------------------------------------
	// 프로필 입력에 반응하기 위한 함수
	//-------------------------------------------------------------------------------------------------------------------------------
	void OnPicture( object wParam=(null), object lParam=(null) )
	{
        //---------------------------------------------------------------------------------------------------------------------------
        // -
        //---------------------------------------------------------------------------------------------------------------------------
		if( (wParam)==(null) || wParam.GetType()!=typeof(tagFacebookProfile) ) return;
		if( (lParam)==(null) || lParam.GetType()!=typeof(tagTexture) ) return;

        //---------------------------------------------------------------------------------------------------------------------------
        // -
        //---------------------------------------------------------------------------------------------------------------------------
		tagFacebookProfile	profile		= (wParam as tagFacebookProfile);
		tagTexture			texture		= (lParam as tagTexture);

        //---------------------------------------------------------------------------------------------------------------------------
        // -
        //---------------------------------------------------------------------------------------------------------------------------
		(profile.Picture)	= (texture);

        //---------------------------------------------------------------------------------------------------------------------------
        // -
        //---------------------------------------------------------------------------------------------------------------------------
//		app.SceneTitle.SetPicture( texture.GetTexture() );

        //---------------------------------------------------------------------------------------------------------------------------
        // -
        //---------------------------------------------------------------------------------------------------------------------------
	}

	//-------------------------------------------------------------------------------------------------------------------------------
	// 프로필 입력에 반응하기 위한 함수
	//-------------------------------------------------------------------------------------------------------------------------------
#if FACEBOOK
	void OnFriendList( IGraphResult result )
	{
        //---------------------------------------------------------------------------------------------------------------------------
        // -
        //---------------------------------------------------------------------------------------------------------------------------
		if( (result)==(null) ) return;
		if( !Library.Is(result.RawResult) ) return;

        //---------------------------------------------------------------------------------------------------------------------------
        // -
        //---------------------------------------------------------------------------------------------------------------------------
//		app.Confirm.ON( result.RawResult );

        //---------------------------------------------------------------------------------------------------------------------------
        // -
        //---------------------------------------------------------------------------------------------------------------------------
		AppsParameter	col		= AppsParameter.Decode(result.RawResult);
		if( (col)==(null) ) return;

        //---------------------------------------------------------------------------------------------------------------------------
        // -
        //---------------------------------------------------------------------------------------------------------------------------
//		Debug.Log(result.RawResult);
		ArrayList	arrayData	= (col.GetNative("data") as ArrayList);
		if( (arrayData)==(null) ) return;

        //---------------------------------------------------------------------------------------------------------------------------
        // -
        //---------------------------------------------------------------------------------------------------------------------------
		AppsParameter	friendHash	= (null);

        //---------------------------------------------------------------------------------------------------------------------------
        // -
        //---------------------------------------------------------------------------------------------------------------------------
		foreach( Hashtable hash in arrayData )
		{
			(friendHash)	= AppsParameter.Init(hash);
			if( (friendHash)!=(null) )
			{
				Register( friendHash.Get("id"), friendHash.Get("name") );
			}
		}

        //---------------------------------------------------------------------------------------------------------------------------
        // -
        //---------------------------------------------------------------------------------------------------------------------------
	}
#endif
	//-------------------------------------------------------------------------------------------------------------------------------
	// 프로필 사진의 URL을 얻기 위한 함수
	//-------------------------------------------------------------------------------------------------------------------------------
	public string GetPictureUrl( AppsParameter col )
	{
        //---------------------------------------------------------------------------------------------------------------------------
        // -
        //---------------------------------------------------------------------------------------------------------------------------
		if( (col)==(null) ) return (null);

        //---------------------------------------------------------------------------------------------------------------------------
        // -
        //---------------------------------------------------------------------------------------------------------------------------
		AppsParameter	data		= AppsParameter.Init(col.GetNative("picture") as Hashtable);
		AppsParameter	picture		= AppsParameter.Init(data.GetNative("data") as Hashtable);

        //---------------------------------------------------------------------------------------------------------------------------
        // -
        //---------------------------------------------------------------------------------------------------------------------------
		return picture.Get("url");
	}

	//-------------------------------------------------------------------------------------------------------------------------------
	// 프로필을 검색하기 위한 함수
	//-------------------------------------------------------------------------------------------------------------------------------
	public tagFacebookProfile Find( string id )
	{
        //---------------------------------------------------------------------------------------------------------------------------
        // -
        //---------------------------------------------------------------------------------------------------------------------------
		if( (id)==(null) ) return (null);

        //---------------------------------------------------------------------------------------------------------------------------
        // -
        //---------------------------------------------------------------------------------------------------------------------------
		foreach( tagFacebookProfile profile in data.Profiles )
		{
			if( (profile.id)==(id) )
			{
				return (profile);
			}
		}

        //---------------------------------------------------------------------------------------------------------------------------
        // -
        //---------------------------------------------------------------------------------------------------------------------------
		return (null);
	}

	//-------------------------------------------------------------------------------------------------------------------------------
	// 인디게이터를 활성화 하기 위한 함수
	//-------------------------------------------------------------------------------------------------------------------------------
	public void Indigator()
	{
		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		app.ViewIndigator.ON( this );

		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
	}

	//-------------------------------------------------------------------------------------------------------------------------------
	// 아이디를 설정하기 위한 함수
	//-------------------------------------------------------------------------------------------------------------------------------
	public void ID( string id )
	{
		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
//		if( (id)==(null) ) return;	//(NULL)값을 허용함

		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		(data.id)	= (id);

		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
	}

	//-------------------------------------------------------------------------------------------------------------------------------
	// 이름을 설정하기 위한 함수
	//-------------------------------------------------------------------------------------------------------------------------------
	public void Name( string name )
	{
		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
//		if( (name)==(null) ) return;	//(NULL)값을 허용함

		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		(data.Name)	= (name);

		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
	}

	//-------------------------------------------------------------------------------------------------------------------------------
	// 아이디를 얻기 위한 함수
	//-------------------------------------------------------------------------------------------------------------------------------
	public string ID()
	{
		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		return (data.id);

		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
	}

	//-------------------------------------------------------------------------------------------------------------------------------
	// 이름을 설정하기 위한 함수
	//-------------------------------------------------------------------------------------------------------------------------------
	public string Name()
	{
		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		return (data.Name);

		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
	}

	//-------------------------------------------------------------------------------------------------------------------------------
	// -
	//-------------------------------------------------------------------------------------------------------------------------------
#endif
}

//-----------------------------------------------------------------------------------------------------------------------------------
// -
//-----------------------------------------------------------------------------------------------------------------------------------