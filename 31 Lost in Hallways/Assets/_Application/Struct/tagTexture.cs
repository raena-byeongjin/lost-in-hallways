using UnityEngine;
using System.Collections.Generic;
using System.Collections;

//텍스쳐 정보를 처리하기 위한 구조체
//[System.Serializable]
public class tagTexture
{
	public string			url						= null;
	public bool				Update					= false;
	public ulong			cache					= 0;

	public string			filepath				= null;
	public Texture2D		texture					= null;
	public byte[]			bytes					= null;

	public int				width					= 0;
	public int				height					= 0;
	public ulong			Size					= 0;

#if UNITY_EDITOR
	public bool				isStreamingSave			= true;
#endif
	public bool				isCacheSave				= true;
	public bool				isBinaryLoad			= false;

	public string			oldUrl					= null;

	public List<object>		Takes					= new List<object>();

	public tagTexture()
	{
	}

	public tagTexture( Texture2D texture )
	{
		if( texture!=null )
		{
			Set( texture );
		}
	}

	public tagTexture( byte[] bytes )
	{
		if( bytes!=null && bytes.Length>0 )
		{
			Load( bytes );
		}
	}

	public tagTexture( string url )
	{
		if( Library.IsUrlOrJar(url) )
		{
			this.url = url;
		}
		else
		if( Library.IsFile(url) )
		{
			if( Load( Func.ReadAllBytes(url) ) )
			{
				cache = Library.GetFileModifyTime(url);
			}
		}
	}

	//텍스쳐를 설정하기 위한 함수
	public void Set( Texture2D texture )
	{
		if( texture==null ) return;

		this.texture	= texture;
		this.width		= texture.width;
		this.height		= texture.height;
	}

	//-------------------------------------------------------------------------------------------------------------------------------
	// 텍스쳐를 불러오기 위한 함수
	//-------------------------------------------------------------------------------------------------------------------------------
	public Texture2D GetTexture()
	{
		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		if( (texture)==(null) && ( (bytes)==(null) || ( (bytes)!=(null) && (bytes.Length)<=(0) ) ) )
		{
			return (null);
		}
		else
		if( (texture)==(null) && (bytes)!=(null) )
		{
			(this.texture)	= CTexture.Load(bytes);
			(this.width)	= (texture.width);
			(this.height)	= (texture.height);
			(this.bytes)	= (null);
		}

		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		return (texture);
	}

	//-------------------------------------------------------------------------------------------------------------------------------
	// 텍스쳐 크기를 얻기 위한 함수
	//-------------------------------------------------------------------------------------------------------------------------------
	public Vector3 GetSize()
	{
		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		return new Vector3( (width), (height), (1) );

		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
	}

	//-------------------------------------------------------------------------------------------------------------------------------
	// -
	//-------------------------------------------------------------------------------------------------------------------------------
	public void Reset()
	{
		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		(texture)	= (null);
		(bytes)		= (null);

		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
	}

	//-------------------------------------------------------------------------------------------------------------------------------
	// 텍스쳐를 초기화 하기 위한 함수
	//-------------------------------------------------------------------------------------------------------------------------------
	public void Unload()
	{
		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		Reset();

		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
	}

	// 텍스쳐를 확인하기 위한 함수
	public bool Is()
	{
		if( Library.Is(this.url) )
		{
			return true;
		}

		return false;
	}

	//-------------------------------------------------------------------------------------------------------------------------------
	// 텍스쳐가 로드되었는지 확인하기 위한 함수
	//-------------------------------------------------------------------------------------------------------------------------------
	public bool IsLoad()
	{
		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		if( (this.texture)!=(null) || ( (this.bytes)!=(null) && (this.bytes.Length)>(0) ) )
		{
			return true;
		}

		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		return false;
	}

	//-------------------------------------------------------------------------------------------------------------------------------
	// -
	//-------------------------------------------------------------------------------------------------------------------------------
	public override string ToString()
	{
		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		if( Library.Is(this.url) )
		{
			return Library.GetFileNameExt(this.url)+" ("+this.width+", "+this.height+") (tagTexture)";
		}

		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		return this.width+"-"+this.height+" ("+base.ToString()+")";
	}

	//-------------------------------------------------------------------------------------------------------------------------------
	// 리소스를 점유하기 위한 함수
	//-------------------------------------------------------------------------------------------------------------------------------
	public void Take( object obj )
	{
		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		if( (obj)==(null) ) return;

		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		if( !Takes.Contains(obj) )
		{
			Takes.Add(obj);
		}

		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
	}

	//-------------------------------------------------------------------------------------------------------------------------------
	// 리소스 점유를 해제하기 위한 함수
	//-------------------------------------------------------------------------------------------------------------------------------
	public bool Untake( object obj )
	{
		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		if( (obj)==(null) ) return false;

		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		Takes.Remove(obj);

        //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
		if( (Takes.Count)<=(0) )
		{
//			Debug.Log("Unload : "+(Url));
			Reset();
			return true;
		}

		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		return false;
	}

	//텍스쳐를 불러오기 위한 함수
	public Texture2D Load()
	{
		texture = GetTexture();
		return texture;
	}

	//텍스쳐를 불러오기 위한 함수
	public Texture2D Load( byte[] bytes )
	{
		if( bytes==null || bytes.Length<=0 ) return null;

		if( texture==null )
		{
			texture = new Texture2D( 0, 0 );
		}

		if( texture.LoadImage(bytes) )
		{
			Set(texture);
		}
		else
		{
#if UNITY_EDITOR
			Debug.Log("텍스쳐를 로드하지 못했습니다.");
#endif
		}

		return texture;
	}

	public void Download()
	{
		DownloadInterface.ON( this );
	}
}